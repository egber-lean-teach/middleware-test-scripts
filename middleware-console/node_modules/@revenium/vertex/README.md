# Revenium Middleware for Vertex AI (Node.js)

[![npm version](https://img.shields.io/npm/v/@revenium/vertex.svg)](https://www.npmjs.com/package/@revenium/vertex)
[![Node Versions](https://img.shields.io/node/v/@revenium/vertex.svg)](https://www.npmjs.com/package/@revenium/vertex)
[![Documentation](https://img.shields.io/badge/docs-revenium.io-blue)](https://docs.revenium.io)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

Automatically track and meter your Vertex AI API usage with Revenium. This middleware provides seamless integration with Vertex AI SDK, requiring minimal code changes.

## üöÄ Getting Started

You have **3 options** to start using Revenium middleware for Vertex AI:

### Option 1: Create Project from Scratch

Perfect for new projects. We'll guide you step-by-step from `mkdir` to running tests.
[üëâ Go to Step-by-Step Guide](#option-1-create-project-from-scratch)

### Option 2: Clone Our Repository

Quick testing with pre-built examples and playground scripts.
[üëâ Go to Clone Guide](#option-2-clone-repository)

### Option 3: Add to Existing Project

Already have a project? Just install and replace imports.
[üëâ Go to Quick Integration](#option-3-existing-project-integration)

---

## Option 1: Create Project from Scratch

### Step 1: Create Project Directory

```bash
# Create and navigate to your project
mkdir my-vertex-ai-project
cd my-vertex-ai-project

# Initialize Node.js project
npm init -y
```

### Step 2: Install Dependencies

```bash
npm install @revenium/vertex
```

### Step 3: Setup Vertex AI Credentials

Create a `keys` directory:

```bash
# Create keys directory
mkdir keys
```

Add Your Service Account JSON

1. Download your Google Cloud service account JSON file
2. Save it as `vertex.json` in the `keys` directory
3. Your project structure should look like:
   ```
   my-vertex-ai-project/
   ‚îú‚îÄ‚îÄ keys/
   ‚îÇ   ‚îî‚îÄ‚îÄ vertex.json
   ‚îú‚îÄ‚îÄ .env
   ‚îî‚îÄ‚îÄ package.json
   ```

### Step 4: Setup Environment Variables

Create a `.env` file in your project root:

```bash
# Create .env file
echo. > .env  # On Windows (CMD TERMINAL)
touch .env  # On Mac/Linux (CMD TERMINAL)
# OR
#PowerShell
New-Item -Path .env -ItemType File
```

Copy and paste the following into `.env`:

```env
# Vertex AI Configuration
GOOGLE_CLOUD_PROJECT_ID=your_gcp_project_id
GOOGLE_CLOUD_LOCATION=us-central1
GOOGLE_CREDENTIALS=C:\\Users\\REVENIUM\\Desktop\\projects\\revenium-vertex\\keys\\vertex.json

# Revenium Configuration
REVENIUM_METERING_API_KEY=your_revenium_api_key_here
REVENIUM_METERING_BASE_URL=https://api.revenium.io/meter

# Optional: Enable debug logging
REVENIUM_LOG_LEVEL=INFO
```

**üí° NOTE**: Replace each `your_..._here` with your actual values.
**üí°NOTE**: You must set GOOGLE_CREDENTIALS to the absolute path of your vertex.json file (use `pwd` in terminal to find it).

### Step 5: Create Your First Test

Create `test-vertex.js`:

```javascript
// test-vertex.js
import { VertexAIReveniumMiddlewareV2 } from "@revenium/vertex";

const vertexAI = new VertexAIReveniumMiddlewareV2();
const model = vertexAI.getGenerativeModel("gemini-2.0-flash-001");

try {
  const result = await model.generateContent({
    request: "What is artificial intelligence?",
    role: "user",
  });

  const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

  console.log("*** RESPONSE ***");
  console.log(text);
  console.log("‚úÖ Vertex AI basic example successful!");
} catch (error) {
  console.error("‚ùå Vertex AI basic example failed:", error);
  process.exit(1);
}
```

### Step 6: Update package.json

Add test scripts and module type to your `package.json`:

```json
{
  "name": "my-vertex-ai-project",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "test-vertex": "node test-vertex.js"
  },
  "dependencies": {
    "@revenium/vertex": "^1.0.0"
  }
}
```

**‚ö†Ô∏è Important**: If you get this error when running tests:

```
SyntaxError: Cannot use import statement outside a module
```

Make sure your `package.json` includes `"type": "module"` as shown above.

### Step 7: Run Your Tests

```bash
# Test Vertex AI SDK
npm run test-vertex
```

### Step 8: Create Advanced Examples

Create an `examples` directory and add these files:

```bash
mkdir examples
```

#### Streaming Example

Create `examples/streaming-vertex.js`:

```javascript
// examples/streaming-vertex.js
import { VertexAIReveniumMiddlewareV2 } from "@revenium/vertex";

const vertexAI = new VertexAIReveniumMiddlewareV2();
const model = vertexAI.getGenerativeModel("gemini-2.0-flash-001");

try {
  const result = await model.generateContentStream({
    model: "gemini-2.0-flash-001",
    contents: [
      {
        role: "user",
        parts: [{ text: "What is the universe?" }],
      },
    ],
  });

  if (!result) {
    console.log("‚ùå No result received from generateContentStream");
    process.exit(1);
  }

  const asyncIterable = result?.[Symbol.asyncIterator]
    ? result
    : result?.stream;

  if (!asyncIterable || !asyncIterable[Symbol.asyncIterator]) {
    console.log("‚ùå No async iterable stream found in result");
    process.exit(1);
  }

  console.log("*** STREAMING RESPONSE ***");
  let fullText = "";

  for await (const chunk of asyncIterable) {
    const text =
      typeof chunk?.text === "function"
        ? chunk.text()
        : chunk?.candidates?.[0]?.content?.parts
            ?.map((p) => p?.text || "")
            .join("") ?? "";

    if (text) {
      process.stdout.write(text);
      fullText += text;
    }
  }

  if (fullText.length > 0) {
    console.log("\n‚úÖ Streaming with metering successful!");
    console.log(`üìä Total response length: ${fullText.length} characters`);
  } else {
    console.log("‚ùå No streaming content received");
  }
} catch (error) {
  console.error("‚ùå Vertex AI streaming example failed:", error);
  process.exit(1);
}
```

#### Embedding Example

Create `examples/embedding-vertex.js`:

```javascript
// examples/embedding-vertex.js
import { VertexAIReveniumMiddlewareV2 } from "@revenium/vertex";

const vertexAI = new VertexAIReveniumMiddlewareV2();
const model = vertexAI.getGenerativeModel("text-embedding-004");

try {
  const result = await model.embedContent({
    contents: ["what is your name?", "what is your favorite color?"],
  });

  if (!result) {
    console.log("‚ùå No result received from embedContent");
    process.exit(1);
  }

  console.log("*** EMBEDDINGS RESPONSE ***");
  console.log("Embeddings count:", result?.embeddings?.length ?? 0);
  console.log(
    "First embedding dims:",
    result?.embeddings?.[0]?.values?.length ?? 0
  );
  console.log("Metadata:", result?.metadata ?? {});
  console.log("‚úÖ Embedding with metering successful!");
} catch (error) {
  console.error("‚ùå Vertex AI embedding example failed:", error);
  process.exit(1);
}
```

### Step 8: Update package.json for Advanced Examples

Add scripts for advanced examples to your `package.json`:

```json
{
  "scripts": {
    "test-vertex": "node test-vertex.js",
    "test-vertex-stream": "node examples/streaming-vertex.js",
    "test-vertex-embed": "node examples/embedding-vertex.js"
  }
}
```

### Step 9: Test Advanced Examples

```bash
# Test streaming
npm run test-vertex-stream

# Test embeddings
npm run test-vertex-embed
```

---

## Option 2: Clone Repository

Perfect for testing with pre-built examples:

```bash
# Clone the repository
git clone git@github.com:revenium/revenium-middleware-google-node.git
cd revenium-middleware-google-node

# Install dependencies
npm install

# Create your .env file
cp .env.example .env
# Edit .env with your API keys
```

### Setup Vertex AI Credentials

```bash
# Create keys directory
mkdir keys
# Add your vertex.json service account file to keys/

# Set absolute path in .env
# Windows: GOOGLE_CREDENTIALS=C:\\path\\to\\your\\project\\keys\\vertex.json
# Mac/Linux: GOOGLE_CREDENTIALS=/path/to/your/project/keys/vertex.json
```

#### Example vertex.json

```bash
# Create keys directory
mkdir keys
# Add your vertex.json service account file to keys/

{
  "type": "...",
  "project_id": "gen...",
  "private_key_id": "6354...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  "client_email": "vertex...",
  "client_id": "1...",
  "auth_uri": "https://accounts...",
  "token_uri": "https://oauth2...",
  "auth_provider_x509_cert_url": "https://www.googleapis...",
  "client_x509_cert_url": "https://www.googleapis.com...",
  "universe_domain": "google..."
}

```

### Configure Environment Variables

Edit your `.env` file:

```env
# For Vertex AI SDK
GOOGLE_CLOUD_PROJECT_ID=your_gcp_project_id
GOOGLE_CLOUD_LOCATION=us-central1
GOOGLE_CREDENTIALS=C:\\Users\\REVENIUM\\Desktop\\projects\\revenium-vertex\\keys\\vertex.json # Adjust path as needed
REVENIUM_METERING_API_KEY=your_revenium_api_key_here
```

### Run Vertex AI Examples

```bash
# Vertex AI examples
npm run v-basic        # Basic chat completion
npm run v-streaming    # Streaming response
npm run v-embedding    # Text embeddings

# Playground examples
# Required build first
npm run build
# Then run any of the following
npm run p-vertex-basic
npm run p-vertex-streaming
npm run p-vertex-embedding
```

---

## Option 3: Existing Project Integration

Already have a project? Just install and replace imports:

### Step 1. Install the Package

```bash
npm install @revenium/vertex
```

### Step 2. Add Environment Variables

Add to your existing `.env` file:

```env
GOOGLE_CLOUD_PROJECT_ID=your_gcp_project_id
GOOGLE_CLOUD_LOCATION=us-central1
GOOGLE_CREDENTIALS=C:\\Users\\REVENIUM\\Desktop\\projects\\revenium-vertex\\keys\\vertex.json # Adjust path as needed
REVENIUM_METERING_API_KEY=your_revenium_api_key_here
REVENIUM_METERING_BASE_URL=https://api.revenium.io/meter
```

### Step 3. Replace Your Imports

**Before:**

```javascript
import { VertexAI } from "@google-cloud/vertexai";
```

**After:**

```javascript
import { VertexAIReveniumMiddlewareV2 } from "@revenium/vertex";
```

### Step 4. Update Your Code

```javascript
import { VertexAIReveniumMiddlewareV2 } from "@revenium/vertex";

// Initialize (credentials from environment variables)
const vertexAI = new VertexAIReveniumMiddlewareV2();
const model = vertexAI.getGenerativeModel("gemini-2.0-flash-001");

// Make your request - metering happens automatically!
const result = await model.generateContent({
  request: "What is artificial intelligence?",
  role: "user",
});

const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
console.log(text);
```

## üîß Advanced Usage

### Streaming Responses

```javascript
const result = await model.generateContentStream({
  contents: [{ role: "user", parts: [{ text: "Write a story about AI" }] }],
});

const stream = result?.[Symbol.asyncIterator] ? result : result?.stream;
for await (const chunk of stream) {
  const text = chunk?.candidates?.[0]?.content?.parts?.[0]?.text;
  if (text) process.stdout.write(text);
}
```

### Text Embeddings

```javascript
const model = vertexAI.getGenerativeModel("text-embedding-004");

const result = await model.embedContent({
  contents: ["Text to embed for search"],
});

console.log(
  `Generated ${result?.embeddings?.[0]?.values?.length} dimensional embedding`
);
```

## üìä What Gets Tracked

- **Token Usage**: Input and output tokens for accurate billing
- **Request Duration**: Total time for each API call
- **Model Information**: Which model was used
- **Operation Type**: Chat completion, embedding, streaming
- **Error Tracking**: Failed requests and error details
- **Streaming Metrics**: Time to first token for streaming responses

## üîó Supported Models

### Chat Models

- `gemini-2.0-flash-001` (Latest)
- `gemini-1.5-pro`
- `gemini-1.5-flash`
- `gemini-1.0-pro`

### Embedding Models

- `text-embedding-004` (Recommended)
- `embedding-001`

## üõ†Ô∏è Configuration Options

### Environment Variables

| Variable                     | Required | Description                       |
| ---------------------------- | -------- | --------------------------------- |
| `GOOGLE_CLOUD_PROJECT_ID`    | ‚úÖ       | Your GCP project ID               |
| `GOOGLE_CLOUD_LOCATION`      | ‚ùå       | GCP region (default: us-central1) |
| `GOOGLE_CREDENTIALS`         | ‚úÖ       | Path to service account JSON      |
| `REVENIUM_METERING_API_KEY`  | ‚úÖ       | Your Revenium API key             |
| `REVENIUM_METERING_BASE_URL` | ‚ùå       | Revenium API base URL             |
| `REVENIUM_LOG_LEVEL`         | ‚ùå       | Log level (DEBUG, INFO, etc.)     |

### Manual Configuration

```javascript
// With manual project configuration
const vertexAI = new VertexAIReveniumMiddlewareV2(
  "your-project-id",
  "us-central1"
);

// With custom configuration
const vertexAI = new VertexAIReveniumMiddlewareV2({
  projectId: "your-project-id",
  location: "us-central1",
  credentialsPath: "./keys/vertex.json",
});
```

## üö® Troubleshooting

### Common Issues

**"Authentication Error"**

```bash
# Verify your service account file exists
ls -la keys/vertex.json

# Check environment variables
echo $GOOGLE_CLOUD_PROJECT_ID
echo $GOOGLE_CREDENTIALS
```

**"Project ID not found"**

```bash
export GOOGLE_CLOUD_PROJECT_ID="your-actual-project-id"
export GOOGLE_CREDENTIALS="$(pwd)/keys/vertex.json"
```

**"Requests not being tracked"**

```bash
export REVENIUM_METERING_API_KEY="your-actual-revenium-key"
export REVENIUM_LOG_LEVEL="DEBUG"  # Enable debug logging
```

**Module Import Errors**

```json
{
  "type": "module"
}
```

### Setting Environment Variables

#### Mac/Linux

```bash
export GOOGLE_CLOUD_PROJECT_ID="your-gcp-project-id"
export GOOGLE_CREDENTIALS="/path/to/service-account.json"
export REVENIUM_METERING_API_KEY="your-revenium-api-key"
```

#### Windows PowerShell

```bash
$env:GOOGLE_CLOUD_PROJECT_ID="your-gcp-project-id"
$env:GOOGLE_CREDENTIALS="C:/path/to/service-account.json"
$env:REVENIUM_METERING_API_KEY="your-revenium-api-key"
```

#### Windows CMD

```bash
set GOOGLE_CLOUD_PROJECT_ID=your-gcp-project-id
set GOOGLE_CREDENTIALS=C:/path/to/service-account.json
set REVENIUM_METERING_API_KEY=your-revenium-api-key
```

## üìã Requirements

- Node.js 18+
- Google Cloud Project with Vertex AI enabled
- Service Account JSON file
- Revenium API key

## üìÑ License

MIT License - see the [LICENSE](../../LICENSE) file for details.

## ü§ù Support

- üìñ [Documentation](https://docs.revenium.com)
- üí¨ [Community Support](https://community.revenium.com)
- üìß [Email Support](mailto:support@revenium.com)
- üêõ [Report Issues](https://github.com/revenium/revenium-middleware-google-node/issues)

---

**Built with ‚ù§Ô∏è by Revenium**
