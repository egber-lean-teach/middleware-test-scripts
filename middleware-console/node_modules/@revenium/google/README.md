# Revenium Middleware for Google AI (Node.js)

[![npm version](https://img.shields.io/npm/v/@revenium/google.svg)](https://www.npmjs.com/package/@revenium/google)
[![Node Versions](https://img.shields.io/node/v/@revenium/google.svg)](https://www.npmjs.com/package/@revenium/google)
[![Documentation](https://img.shields.io/badge/docs-revenium.io-blue)](https://docs.revenium.io)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

Automatically track and meter your Google AI API usage with Revenium. This middleware provides seamless integration with Google AI SDK, requiring minimal code changes.

## üöÄ Getting Started

You have **3 options** to start using Revenium middleware for Google AI:

### Option 1: Create Project from Scratch

Perfect for new projects. We'll guide you step-by-step from `mkdir` to running tests.
[üëâ Go to Step-by-Step Guide](#option-1-create-project-from-scratch)

### Option 2: Clone Our Repository

Quick testing with pre-built examples and playground scripts.
[üëâ Go to Clone Guide](#option-2-clone-repository)

### Option 3: Add to Existing Project

Already have a project? Just install and replace imports.
[üëâ Go to Quick Integration](#option-3-existing-project-integration)

---

## Option 1: Create Project from Scratch

### Step 1: Create Project Directory

```bash
# Create and navigate to your project
mkdir my-google-ai-project
cd my-google-ai-project

# Initialize Node.js project
npm init -y
```

### Step 2: Install Dependencies

```bash
npm install @revenium/google
```

### Step 3: Setup Environment Variables

Create a `.env` file in your project root:

```bash
# Create .env file
echo. > .env  # On Windows (CMD TERMINAL)
touch .env  # On Mac/Linux (CMD TERMINAL)
# OR
#PowerShell
New-Item -Path .env -ItemType File
```

Copy and paste the following into `.env`:

```env
# Google AI Configuration
GOOGLE_API_KEY=your_google_ai_api_key_here

# Revenium Configuration
REVENIUM_METERING_API_KEY=your_revenium_api_key_here
REVENIUM_METERING_BASE_URL=https://api.revenium.io/meter

# Optional: Enable debug logging
REVENIUM_LOG_LEVEL=INFO
```

### Step 4: Create Your First Test

Create `test-google.js`:

```javascript
// test-google.js
import { GoogleAiReveniumMiddleware } from "@revenium/google";

const googleAI = new GoogleAiReveniumMiddleware();
const model = googleAI.getGenerativeModel({ model: "gemini-2.0-flash-001" });

try {
  const result = await model.generateContent("what is the universe");
  const text = result?.candidates?.[0]?.content?.parts?.[0]?.text ?? "";
  console.log("*** RESPONSE ***");
  console.log(text);
  console.log("‚úÖ Basic Google AI example successful!");
} catch (error) {
  console.error("‚ùå Google basic example failed:", error);
  process.exit(1);
}
```

### Step 5: Update package.json

Add test scripts and module type to your `package.json`:

```json
{
  "name": "my-google-ai-project",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "test-google": "node test-google.js"
  },
  "dependencies": {
    "@revenium/google": "^1.0.0"
  }
}
```

**‚ö†Ô∏è Important**: If you get this error when running tests:

```
SyntaxError: Cannot use import statement outside a module
```

Make sure your `package.json` includes `"type": "module"` as shown below.

```json
{
  "type": "module"
}
```

### Step 6: Run Your Tests

```bash
# Test Google AI SDK
npm run test-google
```

### Step 7: Create Advanced Examples

Create an `examples` directory and add these files:

```bash
mkdir examples
```

#### Streaming Example

Create `examples/streaming-google.js`:

```javascript
// examples/streaming-google.js
import { GoogleAiReveniumMiddleware } from "@revenium/google";

const googleAI = new GoogleAiReveniumMiddleware();
const model = googleAI.getGenerativeModel({ model: "gemini-2.0-flash-001" });

try {
  const result = await model.generateContentStream({
    contents: [
      {
        role: "user",
        parts: [{ text: "What is the universe?" }],
      },
    ],
  });

  if (!result) {
    console.log("‚ùå No result received from generateContentStream");
    process.exit(1);
  }

  const asyncIterable = result?.[Symbol.asyncIterator]
    ? result
    : result?.stream;

  if (!asyncIterable || !asyncIterable[Symbol.asyncIterator]) {
    console.log("‚ùå No async iterable stream found in result");
    process.exit(1);
  }

  console.log("*** STREAMING RESPONSE ***");
  let fullText = "";

  for await (const chunk of asyncIterable) {
    const text =
      chunk?.candidates?.[0]?.content?.parts
        ?.map((p) => p?.text || "")
        .join("") ?? "";

    if (text) {
      process.stdout.write(text);
      fullText += text;
    }
  }

  console.log("\n‚úÖ Streaming with metering successful!");
  console.log(`üìä Total response length: ${fullText.length} characters`);
} catch (error) {
  console.error("‚ùå Google streaming example failed:", error);
  process.exit(1);
}
```

#### Embedding Example

Create `examples/embedding-google.js`:

```javascript
// examples/embedding-google.js
import { GoogleAiReveniumMiddleware } from "@revenium/google";

const googleAI = new GoogleAiReveniumMiddleware();
const model = googleAI.getGenerativeModel({ model: "text-embedding-004" });

try {
  const result = await model.embedContent({
    contents: ["A quick brown fox jumps over the lazy dog"],
  });

  if (!result) {
    console.log("‚ùå No result received from embedContent");
    process.exit(1);
  }

  const first = result?.embedding ?? result?.embeddings?.[0];
  console.log("*** EMBEDDINGS RESPONSE ***");
  console.log("First embedding dims:", first?.values?.length ?? 0);
  console.log("‚úÖ Embedding with metering successful!");
} catch (error) {
  console.error("‚ùå Google embedding example failed:", error);
  process.exit(1);
}
```

### Step 8: Update package.json

```json
{
  "name": "my-google-ai-project",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "test-google": "node test-google.js",
    "test-google-stream": "node examples/streaming-google.js",
    "test-google-embed": "node examples/embedding-google.js"
  },
  "dependencies": {
    "@revenium/google": "^1.0.0"
  }
}
```

### Step 9: Test Advanced Examples

```bash
# Test streaming
npm run test-google-stream

# Test embeddings
npm run test-google-embed
```

---

## Option 2: Clone Repository

Perfect for testing with pre-built examples:

```bash
# Clone the repository
git clone git@github.com:revenium/revenium-middleware-google-node.git
cd revenium-middleware-google-node

# Install dependencies
npm install

# Create your .env file
cp .env.example .env
# Edit .env with your API keys
```

### Configure Environment Variables

Edit your `.env` file:

```env
# For Google AI SDK
GOOGLE_API_KEY=your_google_ai_api_key_here
REVENIUM_METERING_API_KEY=your_revenium_api_key_here
REVENIUM_METERING_BASE_URL=https://api.revenium.io/meter

```

### Run Google AI Examples

```bash
# Google AI examples
npm run g-basic        # Basic chat completion
npm run g-streaming    # Streaming response
npm run g-embedding    # Text embeddings

# Playground examples
# Required build first
npm run build
# Then run any of the following
npm run p-google-basic
npm run p-google-streaming
npm run p-google-embedding
```

---

## Option 3: Existing Project Integration

Already have a project? Just install and replace imports:

### Step 1. Install the Package

```bash
npm install @revenium/google
```

### Step 2. Add Environment Variables

Add to your existing `.env` file:

```env
GOOGLE_API_KEY=your_google_ai_api_key_here
REVENIUM_METERING_API_KEY=your_revenium_api_key_here
REVENIUM_METERING_BASE_URL=https://api.revenium.io/meter
# Optional: Enable debug logging
REVENIUM_LOG_LEVEL=INFO
```

### Step 3. Replace Your Imports

**Before:**

```javascript
import { GoogleGenerativeAI } from "@google/generative-ai";
```

**After:**

```javascript
import { GoogleAiReveniumMiddleware } from "@revenium/google";
```

### Step 4. Update Your Code

```javascript
import { GoogleAiReveniumMiddleware } from "@revenium/google";

// Initialize (API key from environment variable)
const googleAI = new GoogleAiReveniumMiddleware();
const model = googleAI.getGenerativeModel({ model: "gemini-2.0-flash-001" });

// Make your request - metering happens automatically!
const result = await model.generateContent("What is artificial intelligence?");
console.log(result?.candidates?.[0]?.content?.parts?.[0]?.text);
```

## üîß Advanced Usage

### Streaming Responses

```javascript
const result = await model.generateContentStream({
  contents: [{ role: "user", parts: [{ text: "Write a story about AI" }] }],
});

for await (const chunk of result) {
  const text = chunk?.candidates?.[0]?.content?.parts?.[0]?.text;
  if (text) process.stdout.write(text);
}
```

### Text Embeddings

```javascript
const model = googleAI.getGenerativeModel({ model: "text-embedding-004" });

const result = await model.embedContent({
  contents: ["Text to embed for search"],
});

console.log(
  `Generated ${result?.embeddings?.[0]?.values?.length} dimensional embedding`
);
```

## üìä What Gets Tracked

- **Token Usage**: Input and output tokens for accurate billing
- **Request Duration**: Total time for each API call
- **Model Information**: Which model was used
- **Operation Type**: Chat completion, embedding, streaming
- **Error Tracking**: Failed requests and error details
- **Streaming Metrics**: Time to first token for streaming responses

## üîó Supported Models

### Chat Models

- `gemini-2.0-flash-001` (Latest)
- `gemini-1.5-pro`
- `gemini-1.5-flash`
- `gemini-1.0-pro`

### Embedding Models

- `text-embedding-004` (Recommended)
- `embedding-001`

## üõ†Ô∏è Configuration Options

### Environment Variables

| Variable                     | Required | Description                   |
| ---------------------------- | -------- | ----------------------------- |
| `GOOGLE_API_KEY`             | ‚úÖ       | Google AI API key             |
| `REVENIUM_METERING_API_KEY`  | ‚úÖ       | Your Revenium API key         |
| `REVENIUM_METERING_BASE_URL` | ‚ùå       | Revenium API base URL         |
| `REVENIUM_LOG_LEVEL`         | ‚ùå       | Log level (DEBUG, INFO, etc.) |

### Manual Configuration

```javascript
// With manual API key
const googleAI = new GoogleAiReveniumMiddleware("your-api-key");

// With custom configuration
const googleAI = new GoogleAiReveniumMiddleware({
  apiKey: "your-api-key",
  meteringConfig: {
    apiKey: "your-revenium-key",
    baseUrl: "https://api.revenium.io/meter",
  },
});
```

## üö® Troubleshooting

### Common Issues

**"Missing API Key" Error**

```bash
export GOOGLE_API_KEY="your-actual-api-key"
echo $GOOGLE_API_KEY  # Verify it's set
```

**"Requests not being tracked"**

```bash
export REVENIUM_METERING_API_KEY="your-actual-revenium-key"
export REVENIUM_LOG_LEVEL="DEBUG"  # Enable debug logging
```

**Module Import Errors**

```json
{
  "type": "module"
}
```

## üìã Requirements

- Node.js 18+
- Google AI API key
- Revenium API key

## üìÑ License

MIT License - see the [LICENSE](../../LICENSE) file for details.

## ü§ù Support

- üìñ [Documentation](https://docs.revenium.com)
- üí¨ [Community Support](https://community.revenium.com)
- üìß [Email Support](mailto:support@revenium.com)
- üêõ [Report Issues](https://github.com/revenium/revenium-middleware-google-node/issues)

---

**Built with ‚ù§Ô∏è by Revenium**
